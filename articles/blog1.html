<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>spatiotemporal arrays for R: stars blog one • stars</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="spatiotemporal arrays for R: stars blog one">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">stars</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/blog1.html">spatiotemporal arrays for R: stars blog one</a>
    </li>
    <li>
      <a href="../articles/data_model.html">stars: data model</a>
    </li>
    <li>
      <a href="../articles/first.html">spatiotemporal tidy arrays for R; first steps</a>
    </li>
    <li>
      <a href="../articles/proxy.html">stars proxy objects</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/r-spatial/stars/">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>spatiotemporal arrays for R: stars blog one</h1>
                        <h4 class="author">Edzer Pebesma</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-spatial/stars//blob/master/vignettes/blog1.Rmd"><code>vignettes/blog1.Rmd</code></a></small>
      <div class="hidden name"><code>blog1.Rmd</code></div>

    </div>

    
    
<p>This is the first of a planned series of blogs on the <a href="https://github.com/r-spatial/stars">stars</a> project, an R-Consortium funded project for <em>spatiotemporal tidy arrays with R</em>.</p>
<p>The goals of the stars project are</p>
<ul>
<li>to handle raster data in a way that integrates well with the <a href="https://github.com/r-spatial/sf">sf</a> project and with the <a href="https://www.tidyverse.org/">tidyverse</a>
</li>
<li>to handle array data (time series, or otherwise functional data) where time and space are among the dimensions</li>
<li>to do this in a scalable way, i.e. deal with cases where data are too large to fit in memory or on disk</li>
<li>to think about a migration path for the large and famous <a href="https://cran.r-project.org/package=raster">raster</a> in the same directions</li>
</ul>
<p>In its current stage <code>stars</code> and (as planned) does not have</p>
<ul>
<li>scalability to large data sets; everything is still in memory</li>
<li>writing data back to disk</li>
</ul>
<p>The package is loaded by</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="co"># devtools::install_github("r-spatial/stars")</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">library</span>(stars)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">## Loading required package: abind</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">## Loading required package: sf</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">## Linking to GEOS 3.5.0, GDAL 2.2.2, PROJ 4.8.0</a>
<a class="sourceLine" id="cb1-6" data-line-number="6">## Registered S3 method overwritten by 'dplyr':</a>
<a class="sourceLine" id="cb1-7" data-line-number="7">##   method               from  </a>
<a class="sourceLine" id="cb1-8" data-line-number="8">##   as.data.frame.tbl_df tibble</a></code></pre></div>
<p>Spatiotemporal arrays are stored in objects of class <code>stars</code>; methods for class <code>stars</code> currently available are</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">methods</span>(<span class="dt">class =</span> <span class="st">"stars"</span>)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">##  [1] [              [&lt;-            adrop          aperm         </a>
<a class="sourceLine" id="cb2-3" data-line-number="3">##  [5] as.data.frame  c              coerce         cut           </a>
<a class="sourceLine" id="cb2-4" data-line-number="4">##  [9] dim            dimnames       dimnames&lt;-     filter        </a>
<a class="sourceLine" id="cb2-5" data-line-number="5">## [13] image          initialize     is.na          Math          </a>
<a class="sourceLine" id="cb2-6" data-line-number="6">## [17] merge          Ops            plot           print         </a>
<a class="sourceLine" id="cb2-7" data-line-number="7">## [21] show           slotsFromS3    split          st_apply      </a>
<a class="sourceLine" id="cb2-8" data-line-number="8">## [25] st_as_sf       st_as_sfc      st_as_stars    st_bbox       </a>
<a class="sourceLine" id="cb2-9" data-line-number="9">## [29] st_coordinates st_crop        st_crs         st_crs&lt;-      </a>
<a class="sourceLine" id="cb2-10" data-line-number="10">## [33] st_dimensions  st_transform   st_write      </a>
<a class="sourceLine" id="cb2-11" data-line-number="11">## see '?methods' for accessing help and source code</a></code></pre></div>
<p>Note that <em>everything</em> in the <code>stars</code> api may still be subject to change in the next few months.</p>
<div id="reading-a-satellite-image" class="section level1">
<h1 class="hasAnchor">
<a href="#reading-a-satellite-image" class="anchor"></a>Reading a satellite image</h1>
<p>We can read a satellite image through GDAL, e.g. from a GeoTIFF file in the package:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">tif =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">"tif/L7_ETMs.tif"</span>, <span class="dt">package =</span> <span class="st">"stars"</span>)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">x &lt;-<span class="st"> </span>tif <span class="op">%&gt;%</span><span class="st"> </span>read_stars </a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">rep</span>(<span class="dv">0</span>,<span class="dv">4</span>))</a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="kw">image</span>(x, <span class="dt">col =</span> <span class="kw">grey</span>((<span class="dv">4</span><span class="op">:</span><span class="dv">10</span>)<span class="op">/</span><span class="dv">10</span>))</a></code></pre></div>
<p><img src="blog1_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<p>We see that the image is geographically referenced (has coordinate values along axes), and that the object returned (<code>x</code>) has three dimensions: <code>x</code>, <code>y</code> and <code>band</code>, and one attribute.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">x</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">## stars object with 3 dimensions and 1 attribute</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">## attribute(s):</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">##   L7_ETMs.tif    </a>
<a class="sourceLine" id="cb4-5" data-line-number="5">##  Min.   :  1.00  </a>
<a class="sourceLine" id="cb4-6" data-line-number="6">##  1st Qu.: 54.00  </a>
<a class="sourceLine" id="cb4-7" data-line-number="7">##  Median : 69.00  </a>
<a class="sourceLine" id="cb4-8" data-line-number="8">##  Mean   : 68.91  </a>
<a class="sourceLine" id="cb4-9" data-line-number="9">##  3rd Qu.: 86.00  </a>
<a class="sourceLine" id="cb4-10" data-line-number="10">##  Max.   :255.00  </a>
<a class="sourceLine" id="cb4-11" data-line-number="11">## dimension(s):</a>
<a class="sourceLine" id="cb4-12" data-line-number="12">##      from  to  offset delta                       refsys point values    </a>
<a class="sourceLine" id="cb4-13" data-line-number="13">## x       1 349  288776  28.5 +proj=utm +zone=25 +south... FALSE   NULL [x]</a>
<a class="sourceLine" id="cb4-14" data-line-number="14">## y       1 352 9120761 -28.5 +proj=utm +zone=25 +south... FALSE   NULL [y]</a>
<a class="sourceLine" id="cb4-15" data-line-number="15">## band    1   6      NA    NA                           NA    NA   NULL</a></code></pre></div>
<p>Each dimension has a name; the meaning of the fields of a single dimension are:</p>
<table class="table">
<thead><tr class="header">
<th><em>field</em></th>
<th><em>meaning</em></th>
</tr></thead>
<tbody>
<tr class="odd">
<td>from</td>
<td>the origin index (1)</td>
</tr>
<tr class="even">
<td>to</td>
<td>the final index (dim(x)[i])</td>
</tr>
<tr class="odd">
<td>offset</td>
<td>the start value for this dimension</td>
</tr>
<tr class="even">
<td>delta</td>
<td>the step size for this dimension</td>
</tr>
<tr class="odd">
<td>refsys</td>
<td>the reference system, or proj4string</td>
</tr>
<tr class="even">
<td>point</td>
<td>logical; whether cells refer to points, or intervals</td>
</tr>
<tr class="odd">
<td>values</td>
<td>the sequence of values for this dimension (e.g., geometries)</td>
</tr>
</tbody>
</table>
<p>This means that for an index i (starting at <span class="math inline">\(i=1\)</span>) along a certain dimension, the corresponding dimension value (coordinate, time) is <span class="math inline">\(\mbox{offset} + (i-1) \times \mbox{delta}\)</span>. This value then refers to the start (edge) of the cell or interval; in order to get the interval middle or cell centre, one needs to add half an offset.</p>
<p>Dimension <code>band</code> is a simple sequence from 1 to 6. Although bands refer to colors, their wavelength values (or b in the <code>values</code> field.</p>
<p>For this particular dataset (and most other raster datasets), we see that offset for dimension <code>y</code> is negative: this means that consecutive array values have decreasing <span class="math inline">\(y\)</span> values: cells are ordered from top to bottom, opposite the direction of the <span class="math inline">\(y\)</span> axis.</p>
<p><code>read_stars</code> reads all bands from a raster dataset, or a set of raster datasets, into a single <code>stars</code> array structure. While doing so, raster values (often UINT8 or UINT16) are converted to double (numeric) values, and scaled back to their original values if needed.</p>
<p>The data structure <code>stars</code> is an extension of the <code>tbl_cube</code> found in <code>dplyr</code>; we can convert to that by</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">## </a>
<a class="sourceLine" id="cb5-3" data-line-number="3">## Attaching package: 'dplyr'</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">## The following objects are masked from 'package:stats':</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">## </a>
<a class="sourceLine" id="cb5-6" data-line-number="6">##     filter, lag</a>
<a class="sourceLine" id="cb5-7" data-line-number="7">## The following objects are masked from 'package:base':</a>
<a class="sourceLine" id="cb5-8" data-line-number="8">## </a>
<a class="sourceLine" id="cb5-9" data-line-number="9">##     intersect, setdiff, setequal, union</a>
<a class="sourceLine" id="cb5-10" data-line-number="10"><span class="kw"><a href="http://dplyr.tidyverse.org/reference/as.tbl_cube.html">as.tbl_cube</a></span>(x)</a>
<a class="sourceLine" id="cb5-11" data-line-number="11">## Source: local array [737,088 x 3]</a>
<a class="sourceLine" id="cb5-12" data-line-number="12">## D: x [dbl, 349]</a>
<a class="sourceLine" id="cb5-13" data-line-number="13">## D: y [dbl, 352]</a>
<a class="sourceLine" id="cb5-14" data-line-number="14">## D: band [int, 6]</a>
<a class="sourceLine" id="cb5-15" data-line-number="15">## M: L7_ETMs.tif [dbl]</a></code></pre></div>
</div>
<div id="affine-grids" class="section level1">
<h1 class="hasAnchor">
<a href="#affine-grids" class="anchor"></a>Affine grids</h1>
<p>The GDAL model can deal also with spatial rasters that are regular but not aligned with <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span>: affine grids. An example is given here:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw">par</span>(<span class="dt">cex.axis =</span> <span class="fl">.7</span>) <span class="co"># font size axis tic labels </span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">geomatrix =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">"tif/geomatrix.tif"</span>, <span class="dt">package =</span> <span class="st">"stars"</span>)</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">geomatrix <span class="op">%&gt;%</span><span class="st"> </span>read_stars <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/st_as_sf.html">st_as_sf</a></span>(<span class="dt">as_points =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="st">  </span><span class="kw">plot</span>(<span class="dt">axes =</span><span class="ot">TRUE</span>, <span class="dt">main =</span> <span class="st">"geomatrix.tif"</span>, <span class="dt">graticule =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<p><img src="blog1_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p>Looking at the dimensions</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">geomatrix <span class="op">%&gt;%</span><span class="st"> </span>read_stars <span class="op">%&gt;%</span><span class="st"> </span>st_dimensions</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">##   from to  offset delta                       refsys point values    </a>
<a class="sourceLine" id="cb7-3" data-line-number="3">## x    1 20 1841002   1.5 +proj=utm +zone=11 +datum...  TRUE   NULL [x]</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">## y    1 20 1144003  -1.5 +proj=utm +zone=11 +datum...  TRUE   NULL [y]</a>
<a class="sourceLine" id="cb7-5" data-line-number="5">## sheared raster with parameters: -5 -5</a></code></pre></div>
<p>further reveals that we now have a <code>geotransform</code> field shown in the dimension table; this is only displayed when the affine parameters are non-zero. The geotransform field has six parameters, <span class="math inline">\(gt_1,...,gt_6\)</span> that are used to transform internal raster coordinates (column pixel <span class="math inline">\(i\)</span> and row pixel <span class="math inline">\(j\)</span>) to world coordinates (<span class="math inline">\(x\)</span>, <span class="math inline">\(y\)</span>):</p>
<p><span class="math display">\[x = gt_1 + (i-1) gt_2 + (j-1) gt_3\]</span></p>
<p><span class="math display">\[y = gt_4 + (i-1) gt_5 + (j-1) gt_6\]</span></p>
<p>When <span class="math inline">\(gt_3\)</span> and <span class="math inline">\(gt_5\)</span> are zero, the <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> are parallel to <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span>, which makes it appear unrotated.</p>
</div>
<div id="reading-a-raster-time-series-netcdf" class="section level1">
<h1 class="hasAnchor">
<a href="#reading-a-raster-time-series-netcdf" class="anchor"></a>Reading a raster time series: netcdf</h1>
<p>Another example is when we read raster time series model outputs in a NetCDF file, e.g. by</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">prec =<span class="st"> </span><span class="kw"><a href="../reference/read_stars.html">read_stars</a></span>(<span class="st">"data/full_data_daily_2013.nc"</span>)</a></code></pre></div>
<p>(Note that this 380 Mb file is not included; data are described <a href="ftp://ftp.dwd.de/pub/data/gpcc/html/fulldata-daily_v1_doi_download.html">here</a>, and were downloaded from <a href="ftp://ftp.dwd.de/pub/data/gpcc/full_data_daily_V1/full_data_daily_2013.nc.gz">here</a>).</p>
<p>We see that</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">prec</a></code></pre></div>
<p>For this dataset we can see that</p>
<ul>
<li>variables have units associated</li>
<li>time is now a dimension, with proper units and time steps</li>
<li>missing values for the fourth variable were not taken care off correctly</li>
</ul>
<div id="reading-datasets-from-multiple-files" class="section level2">
<h2 class="hasAnchor">
<a href="#reading-datasets-from-multiple-files" class="anchor"></a>Reading datasets from multiple files</h2>
<p>Model data are often spread across many files. An example of a 0.25 degree grid, global daily sea surface temperature product is found <a href="ftp://eclipse.ncdc.noaa.gov/pub/OI-daily-v2/NetCDF/">here</a>; a subset of the 1981 data was downloaded from <a href="ftp://eclipse.ncdc.noaa.gov/pub/OI-daily-v2/NetCDF/1981/AVHRR/">here</a>.</p>
<p>We read the data by giving <code>read_stars</code> a vector with character names:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">x =<span class="st"> </span><span class="kw">c</span>(</a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="st">"avhrr/avhrr-only-v2.19810901.nc"</span>,</a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="st">"avhrr/avhrr-only-v2.19810902.nc"</span>,</a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="st">"avhrr/avhrr-only-v2.19810903.nc"</span>,</a>
<a class="sourceLine" id="cb10-5" data-line-number="5"><span class="st">"avhrr/avhrr-only-v2.19810904.nc"</span>,</a>
<a class="sourceLine" id="cb10-6" data-line-number="6"><span class="st">"avhrr/avhrr-only-v2.19810905.nc"</span>,</a>
<a class="sourceLine" id="cb10-7" data-line-number="7"><span class="st">"avhrr/avhrr-only-v2.19810906.nc"</span>,</a>
<a class="sourceLine" id="cb10-8" data-line-number="8"><span class="st">"avhrr/avhrr-only-v2.19810907.nc"</span>,</a>
<a class="sourceLine" id="cb10-9" data-line-number="9"><span class="st">"avhrr/avhrr-only-v2.19810908.nc"</span>,</a>
<a class="sourceLine" id="cb10-10" data-line-number="10"><span class="st">"avhrr/avhrr-only-v2.19810909.nc"</span></a>
<a class="sourceLine" id="cb10-11" data-line-number="11">)</a>
<a class="sourceLine" id="cb10-12" data-line-number="12"></a>
<a class="sourceLine" id="cb10-13" data-line-number="13">(<span class="dt">y =</span> <span class="kw"><a href="../reference/read_stars.html">read_stars</a></span>(x, <span class="dt">quiet =</span> <span class="ot">TRUE</span>))</a></code></pre></div>
<p>Next, we select sea surface temperature (<code>sst</code>), and drop the singular <code>zlev</code> (depth) dimension using <code>adrop</code>:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw">library</span>(abind)</a>
<a class="sourceLine" id="cb11-2" data-line-number="2">z &lt;-<span class="st"> </span>y <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(sst) <span class="op">%&gt;%</span><span class="st"> </span>adrop</a></code></pre></div>
<p>We can now graph the sea surface temperature (SST) using <code>ggplot</code>, which needs data in a long table form, and without units:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">df =<span class="st"> </span><span class="kw">as.data.frame</span>(z)</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">df<span class="op">$</span>sst =<span class="st"> </span><span class="kw">unclass</span>(df<span class="op">$</span>sst)</a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="kw">library</span>(ggplot2)</a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="kw">library</span>(viridis)</a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="kw">library</span>(ggthemes)</a>
<a class="sourceLine" id="cb12-6" data-line-number="6"><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>() <span class="op">+</span><span class="st">  </span></a>
<a class="sourceLine" id="cb12-7" data-line-number="7"><span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_tile">geom_tile</a></span>(<span class="dt">data=</span>df, <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x=</span>x, <span class="dt">y=</span>y, <span class="dt">fill=</span>sst), <span class="dt">alpha=</span><span class="fl">0.8</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-8" data-line-number="8"><span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/facet_wrap">facet_wrap</a></span>(<span class="st">"time"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb12-9" data-line-number="9"><span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/viridis/topics/scale_viridis">scale_fill_viridis</a></span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb12-10" data-line-number="10"><span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/coord_fixed">coord_equal</a></span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb12-11" data-line-number="11"><span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggthemes/topics/theme_map">theme_map</a></span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb12-12" data-line-number="12"><span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/theme">theme</a></span>(<span class="dt">legend.position=</span><span class="st">"bottom"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb12-13" data-line-number="13"><span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/theme">theme</a></span>(<span class="dt">legend.key.width=</span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/reexports">unit</a></span>(<span class="dv">2</span>, <span class="st">"cm"</span>))</a></code></pre></div>
</div>
</div>
<div id="more-complex-arrays" class="section level1">
<h1 class="hasAnchor">
<a href="#more-complex-arrays" class="anchor"></a>More complex arrays</h1>
<p>Like <code>tbl_cube</code>, <code>stars</code> arrays have no limits to the number of dimensions they handle. An example is the origin-destination (OD) matrix, by time and travel mode.</p>
<div id="od-space-x-space-x-travel-mode-x-time-x-time" class="section level2">
<h2 class="hasAnchor">
<a href="#od-space-x-space-x-travel-mode-x-time-x-time" class="anchor"></a>OD: space x space x travel mode x time x time</h2>
<p>We create a 5-dimensional matrix of traffic between regions, by day, by time of day, and by travel mode. Having day and time of day each as dimension is an advantage when we want to compute patters over the day, for a certain period.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">nc =<span class="st"> </span><span class="kw">st_read</span>(<span class="kw">system.file</span>(<span class="st">"gpkg/nc.gpkg"</span>, <span class="dt">package=</span><span class="st">"sf"</span>)) </a>
<a class="sourceLine" id="cb13-2" data-line-number="2">## Reading layer `nc.gpkg' from data source `/home/travis/R/Library/sf/gpkg/nc.gpkg' using driver `GPKG'</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">## Simple feature collection with 100 features and 14 fields</a>
<a class="sourceLine" id="cb13-4" data-line-number="4">## geometry type:  MULTIPOLYGON</a>
<a class="sourceLine" id="cb13-5" data-line-number="5">## dimension:      XY</a>
<a class="sourceLine" id="cb13-6" data-line-number="6">## bbox:           xmin: -84.32385 ymin: 33.88199 xmax: -75.45698 ymax: 36.58965</a>
<a class="sourceLine" id="cb13-7" data-line-number="7">## epsg (SRID):    4267</a>
<a class="sourceLine" id="cb13-8" data-line-number="8">## proj4string:    +proj=longlat +datum=NAD27 +no_defs</a>
<a class="sourceLine" id="cb13-9" data-line-number="9">to =<span class="st"> </span>from =<span class="st"> </span><span class="kw">st_geometry</span>(nc) <span class="co"># 100 polygons: O and D regions</span></a>
<a class="sourceLine" id="cb13-10" data-line-number="10">mode =<span class="st"> </span><span class="kw">c</span>(<span class="st">"car"</span>, <span class="st">"bike"</span>, <span class="st">"foot"</span>) <span class="co"># travel mode</span></a>
<a class="sourceLine" id="cb13-11" data-line-number="11">day =<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">100</span> <span class="co"># arbitrary</span></a>
<a class="sourceLine" id="cb13-12" data-line-number="12"><span class="kw">library</span>(units)</a>
<a class="sourceLine" id="cb13-13" data-line-number="13">## Warning in .get_ud_xml_dir(TRUE): multiple udunits databases present: /</a>
<a class="sourceLine" id="cb13-14" data-line-number="14">## home/travis/R/Library/RNetCDF/udunits/udunits2.xml /usr/share/xml/udunits/</a>
<a class="sourceLine" id="cb13-15" data-line-number="15">## udunits2.xml</a>
<a class="sourceLine" id="cb13-16" data-line-number="16">## udunits system database from /home/travis/R/Library/RNetCDF/udunits</a>
<a class="sourceLine" id="cb13-17" data-line-number="17"><span class="kw"><a href="http://www.rdocumentation.org/packages/units/topics/units">units</a></span>(day) =<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/units/topics/as_units">as_units</a></span>(<span class="st">"days since 2015-01-01"</span>)</a>
<a class="sourceLine" id="cb13-18" data-line-number="18">hour =<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/units/topics/set_units">set_units</a></span>(<span class="dv">0</span><span class="op">:</span><span class="dv">23</span>, h) <span class="co"># hour of day</span></a>
<a class="sourceLine" id="cb13-19" data-line-number="19">dims =<span class="st"> </span><span class="kw"><a href="../reference/st_dimensions.html">st_dimensions</a></span>(<span class="dt">origin =</span> from, <span class="dt">destination =</span> to, <span class="dt">mode =</span> mode, <span class="dt">day =</span> day, <span class="dt">hour =</span> hour)</a>
<a class="sourceLine" id="cb13-20" data-line-number="20">(<span class="dt">n =</span> <span class="kw">dim</span>(dims))</a>
<a class="sourceLine" id="cb13-21" data-line-number="21">##      origin destination        mode         day        hour </a>
<a class="sourceLine" id="cb13-22" data-line-number="22">##         100         100           3         100          24</a>
<a class="sourceLine" id="cb13-23" data-line-number="23">traffic =<span class="st"> </span><span class="kw">array</span>(<span class="kw">rpois</span>(<span class="kw">prod</span>(n), <span class="dv">10</span>), <span class="dt">dim =</span> n) <span class="co"># simulated traffic counts</span></a>
<a class="sourceLine" id="cb13-24" data-line-number="24">(<span class="dt">st =</span> <span class="kw"><a href="../reference/st_as_stars.html">st_as_stars</a></span>(<span class="kw">list</span>(<span class="dt">traffic =</span> traffic),  <span class="dt">dimensions =</span> dims))</a>
<a class="sourceLine" id="cb13-25" data-line-number="25">## stars object with 5 dimensions and 1 attribute</a>
<a class="sourceLine" id="cb13-26" data-line-number="26">## attribute(s), summary of first 1e+05 cells:</a>
<a class="sourceLine" id="cb13-27" data-line-number="27">##     traffic      </a>
<a class="sourceLine" id="cb13-28" data-line-number="28">##  Min.   : 0.000  </a>
<a class="sourceLine" id="cb13-29" data-line-number="29">##  1st Qu.: 8.000  </a>
<a class="sourceLine" id="cb13-30" data-line-number="30">##  Median :10.000  </a>
<a class="sourceLine" id="cb13-31" data-line-number="31">##  Mean   : 9.997  </a>
<a class="sourceLine" id="cb13-32" data-line-number="32">##  3rd Qu.:12.000  </a>
<a class="sourceLine" id="cb13-33" data-line-number="33">##  Max.   :26.000  </a>
<a class="sourceLine" id="cb13-34" data-line-number="34">## dimension(s):</a>
<a class="sourceLine" id="cb13-35" data-line-number="35">##             from  to                      offset</a>
<a class="sourceLine" id="cb13-36" data-line-number="36">## origin         1 100                          NA</a>
<a class="sourceLine" id="cb13-37" data-line-number="37">## destination    1 100                          NA</a>
<a class="sourceLine" id="cb13-38" data-line-number="38">## mode           1   3                          NA</a>
<a class="sourceLine" id="cb13-39" data-line-number="39">## day            1 100 1 [(days since 2015-01-01)]</a>
<a class="sourceLine" id="cb13-40" data-line-number="40">## hour           1  24                       0 [h]</a>
<a class="sourceLine" id="cb13-41" data-line-number="41">##                                   delta                       refsys point</a>
<a class="sourceLine" id="cb13-42" data-line-number="42">## origin                               NA +proj=longlat +datum=NAD2... FALSE</a>
<a class="sourceLine" id="cb13-43" data-line-number="43">## destination                          NA +proj=longlat +datum=NAD2... FALSE</a>
<a class="sourceLine" id="cb13-44" data-line-number="44">## mode                                 NA                           NA    NA</a>
<a class="sourceLine" id="cb13-45" data-line-number="45">## day         1 [(days since 2015-01-01)]                           NA    NA</a>
<a class="sourceLine" id="cb13-46" data-line-number="46">## hour                              1 [h]                           NA    NA</a>
<a class="sourceLine" id="cb13-47" data-line-number="47">##                                                                          values</a>
<a class="sourceLine" id="cb13-48" data-line-number="48">## origin      MULTIPOLYGON (((-81.47276 3..., ..., MULTIPOLYGON (((-78.65572 3...</a>
<a class="sourceLine" id="cb13-49" data-line-number="49">## destination MULTIPOLYGON (((-81.47276 3..., ..., MULTIPOLYGON (((-78.65572 3...</a>
<a class="sourceLine" id="cb13-50" data-line-number="50">## mode                                                             car, ..., foot</a>
<a class="sourceLine" id="cb13-51" data-line-number="51">## day                                                                        NULL</a>
<a class="sourceLine" id="cb13-52" data-line-number="52">## hour                                                                       NULL</a></code></pre></div>
<p>This array contains the simple feature geometries of origin and destination so that we can directly plot every slice without additional table joins. If we want to represent such an array as a <code>tbl_cube</code>, the simple feature geometry dimensions need to be replaced by indexes:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">st <span class="op">%&gt;%</span><span class="st"> </span>as.tbl_cube </a>
<a class="sourceLine" id="cb14-2" data-line-number="2">## Source: local array [72,000,000 x 5]</a>
<a class="sourceLine" id="cb14-3" data-line-number="3">## D: origin [int, 100]</a>
<a class="sourceLine" id="cb14-4" data-line-number="4">## D: destination [int, 100]</a>
<a class="sourceLine" id="cb14-5" data-line-number="5">## D: mode [chr, 3]</a>
<a class="sourceLine" id="cb14-6" data-line-number="6">## D: day [[(days since 2015-01-01)], 100]</a>
<a class="sourceLine" id="cb14-7" data-line-number="7">## D: hour [[h], 24]</a>
<a class="sourceLine" id="cb14-8" data-line-number="8">## M: traffic [int]</a></code></pre></div>
<p>The following demonstrates how <code>dplyr</code> can filter bike travel, and compute mean bike traffic by hour of day:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">b &lt;-<span class="st"> </span>st <span class="op">%&gt;%</span><span class="st"> </span>as.tbl_cube <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(mode <span class="op">==</span><span class="st"> "bike"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(hour) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="dt">traffic =</span> <span class="kw">mean</span>(traffic)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-5" data-line-number="5"><span class="st">  </span><span class="kw">as.data.frame</span>()</a>
<a class="sourceLine" id="cb15-6" data-line-number="6"><span class="kw">require</span>(ggforce)</a>
<a class="sourceLine" id="cb15-7" data-line-number="7"><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>() <span class="op">+</span><span class="st">  </span></a>
<a class="sourceLine" id="cb15-8" data-line-number="8"><span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_path">geom_line</a></span>(<span class="dt">data=</span>b, <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x=</span>hour, <span class="dt">y=</span>traffic))</a></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#reading-a-satellite-image">Reading a satellite image</a></li>
      <li><a href="#affine-grids">Affine grids</a></li>
      <li>
<a href="#reading-a-raster-time-series-netcdf">Reading a raster time series: netcdf</a><ul class="nav nav-pills nav-stacked">
<li><a href="#reading-datasets-from-multiple-files">Reading datasets from multiple files</a></li>
      </ul>
</li>
      <li>
<a href="#more-complex-arrays">More complex arrays</a><ul class="nav nav-pills nav-stacked">
<li><a href="#od-space-x-space-x-travel-mode-x-time-x-time">OD: space x space x travel mode x time x time</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Edzer Pebesma.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
